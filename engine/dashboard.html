<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClawTrace Dashboard</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #0f172a;
            color: white;
            padding: 1rem;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        /* Header */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        h1 { font-size: 2rem; color: #f97316; }
        .device-badge {
            background-color: #1e293b;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .header-right { display: flex; align-items: center; gap: 0.75rem; }
        .alert-header-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }
        .alert-header-badge.has-crit { background: #dc2626; color: white; }
        .alert-header-badge.has-warn { background: #f97316; color: white; }
        .alert-header-badge.has-none { background: #1e293b; color: #64748b; border: 1px solid #334155; }
        .alert-header-badge:hover { opacity: 0.85; }

        /* Hero Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background-color: #1e293b;
            padding: 1.25rem;
            border-radius: 0.5rem;
            border: 1px solid #334155;
        }
        .stat-label { color: #94a3b8; font-size: 0.8rem; margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-value { font-size: 1.75rem; font-weight: bold; color: #f97316; }
        .stat-delta { font-size: 0.8rem; margin-top: 0.25rem; }
        .stat-delta.up { color: #ef4444; }
        .stat-delta.down { color: #22c55e; }
        .stat-delta.neutral { color: #64748b; }
        .stat-card.savings { border-color: #22c55e; }
        .stat-card.savings .stat-value { color: #22c55e; }

        /* Alert Panel (collapsed by default) */
        .alert-panel {
            background-color: #1e293b;
            border: 1px solid #475569;
            border-radius: 0.5rem;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
        }
        .alert-group-title {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .alert-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid #1e293b;
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            font-size: 0.875rem;
        }
        .alert-item:last-child { border-bottom: none; }
        .alert-badge {
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
            color: white;
        }
        .alert-badge.critical { background: #dc2626; }
        .alert-badge.warning { background: #f97316; }
        .alert-dismiss-all {
            background: transparent;
            border: 1px solid #475569;
            color: #94a3b8;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.7rem;
        }
        .alert-dismiss-all:hover { border-color: #94a3b8; color: white; }

        /* Top Savings Cards */
        .savings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .savings-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #22c55e40;
            border-radius: 0.5rem;
            padding: 1rem 1.25rem;
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }
        .savings-badge {
            background: #dc2626;
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
            margin-top: 0.15rem;
        }
        .savings-text { font-size: 0.875rem; }
        .savings-amount { color: #22c55e; font-size: 0.8rem; font-weight: 600; margin-top: 0.25rem; }
        .view-all-link {
            color: #f97316;
            font-size: 0.85rem;
            cursor: pointer;
            text-align: center;
            padding: 0.5rem;
        }
        .view-all-link:hover { text-decoration: underline; }

        /* Chart */
        .chart-container {
            background-color: #1e293b;
            padding: 1.25rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #334155;
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .chart-title { font-size: 1.125rem; }
        .range-toggle {
            display: flex;
            gap: 0;
            border: 1px solid #475569;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        .range-btn {
            background: transparent;
            color: #94a3b8;
            border: none;
            padding: 0.35rem 0.75rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
            border-right: 1px solid #475569;
        }
        .range-btn:last-child { border-right: none; }
        .range-btn.active { background: #f97316; color: white; }
        .range-btn:hover:not(.active) { background: #334155; }
        .range-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .range-btn .pro-badge {
            font-size: 0.6rem;
            background: #475569;
            padding: 0.05rem 0.3rem;
            border-radius: 0.2rem;
            margin-left: 0.25rem;
            vertical-align: super;
        }

        /* Tables */
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .table-container {
            background-color: #1e293b;
            padding: 1.25rem;
            border-radius: 0.5rem;
            border: 1px solid #334155;
            overflow-x: auto;
        }
        .table-title { font-size: 1.125rem; margin-bottom: 0.75rem; }
        table { width: 100%; border-collapse: collapse; }
        th {
            text-align: left;
            padding: 0.6rem 0.75rem;
            border-bottom: 2px solid #334155;
            color: #94a3b8;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        td { padding: 0.6rem 0.75rem; border-bottom: 1px solid #334155; font-size: 0.875rem; }
        tr:last-child td { border-bottom: none; }
        .mono { font-family: monospace; font-size: 0.8rem; }
        .pct-col { color: #94a3b8; font-size: 0.8rem; }
        .show-more {
            color: #f97316;
            font-size: 0.8rem;
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            text-align: center;
        }
        .show-more:hover { text-decoration: underline; }

        /* Collapsible sections */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .collapsible-header .toggle-icon {
            color: #64748b;
            font-size: 0.8rem;
            transition: transform 0.2s;
        }

        /* Waiting state */
        .waiting {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
            font-size: 1.125rem;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem 0 1rem;
            color: #64748b;
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.5rem; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .savings-grid { grid-template-columns: 1fr; }
            .tables-grid { grid-template-columns: 1fr; }
            .stat-value { font-size: 1.35rem; }
            header { flex-direction: column; align-items: flex-start; }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container" x-data="dashboard()">
        <!-- 1. Header -->
        <header>
            <div class="header-left">
                <h1>ClawTrace</h1>
                <div class="device-badge" x-text="deviceId ? deviceId.substring(0, 12) + '...' : 'Loading...'"></div>
            </div>
            <div class="header-right">
                <!-- Alert badge in header -->
                <div class="alert-header-badge"
                     :class="alertSeverityClass"
                     @click="alertsOpen = !alertsOpen"
                     x-show="alerts.length > 0">
                    <span x-text="alerts.length + ' alert' + (alerts.length !== 1 ? 's' : '')"></span>
                    <span x-text="alertsOpen ? '&#9650;' : '&#9660;'" style="font-size: 0.6rem;"></span>
                </div>
            </div>
        </header>

        <div x-show="!loading && stats.total_requests === 0" class="waiting">
            Waiting for data...
        </div>

        <div x-show="!loading && stats.total_requests > 0">

            <!-- 2. Hero Stats (redesigned) -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Today's Cost</div>
                    <div class="stat-value" x-text="'$' + todayCost.toFixed(2)"></div>
                    <div class="stat-delta" :class="todayDeltaClass" x-text="todayDeltaText"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">This Week</div>
                    <div class="stat-value" x-text="'$' + weekCost.toFixed(2)"></div>
                    <div class="stat-delta" :class="weekDeltaClass" x-text="weekDeltaText"></div>
                </div>
                <div class="stat-card savings">
                    <div class="stat-label">Potential Savings</div>
                    <div class="stat-value" x-text="potentialSavings > 0 ? '$' + potentialSavings.toFixed(0) + '/wk' : '--'"></div>
                    <div class="stat-delta neutral" x-text="highSuggestionCount + ' optimization' + (highSuggestionCount !== 1 ? 's' : '') + ' found'"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Top Cost Driver</div>
                    <div class="stat-value" style="font-size: 1rem; word-break: break-all;" x-text="topCostDriver"></div>
                    <div class="stat-delta neutral" x-text="topCostPct + '% of total spend'"></div>
                </div>
            </div>

            <!-- Alert Panel (collapsed, shown when badge clicked) -->
            <div class="alert-panel" x-show="alertsOpen && alerts.length > 0" x-transition>
                <template x-for="[type, items] in Object.entries(groupedAlerts)" :key="type">
                    <div style="margin-bottom: 0.75rem;">
                        <div class="alert-group-title">
                            <span x-text="items.length + ' ' + type"></span>
                            <button class="alert-dismiss-all" @click="dismissGroup(items)">Dismiss all</button>
                        </div>
                        <template x-for="alert in items" :key="alert.id">
                            <div class="alert-item">
                                <span class="alert-badge" :class="alert.severity" x-text="alert.severity === 'critical' ? 'CRIT' : 'WARN'"></span>
                                <div style="flex: 1;">
                                    <div x-text="alert.message"></div>
                                    <div style="color: #64748b; font-size: 0.75rem; margin-top: 0.15rem;" x-text="formatTime(alert.created_at)"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>

            <!-- 3. Top 3 Savings (promoted from suggestions) -->
            <div x-show="topSuggestions.length > 0">
                <div class="savings-grid">
                    <template x-for="(s, i) in topSuggestions" :key="i">
                        <div class="savings-card">
                            <span class="savings-badge">HIGH</span>
                            <div>
                                <div class="savings-text" x-text="s.message"></div>
                                <div class="savings-amount" x-show="s.estimated_savings" x-text="'Save $' + (s.estimated_savings ? s.estimated_savings.toFixed(0) : 0) + '/week'"></div>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="view-all-link"
                     x-show="suggestions.length > 3"
                     @click="allSuggestionsOpen = !allSuggestionsOpen"
                     x-text="allSuggestionsOpen ? 'Hide suggestions' : 'View all ' + suggestions.length + ' suggestions'">
                </div>
                <!-- Full suggestions list (hidden by default) -->
                <div class="table-container" x-show="allSuggestionsOpen" x-transition style="margin-bottom: 1.5rem; border-color: #f97316;">
                    <template x-for="(s, i) in suggestions" :key="'all-' + i">
                        <div style="padding: 0.5rem 0; border-bottom: 1px solid #334155; display: flex; gap: 0.75rem; align-items: flex-start; font-size: 0.875rem;">
                            <span :style="'background:' + (s.severity === 'high' ? '#dc2626' : s.severity === 'medium' ? '#f97316' : '#64748b') + '; color: white; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600; white-space: nowrap;'"
                                  x-text="s.severity.toUpperCase()"></span>
                            <div style="flex: 1;">
                                <div x-text="s.message"></div>
                                <div x-show="s.estimated_savings" style="color: #22c55e; font-size: 0.8rem; margin-top: 0.15rem;" x-text="'Potential savings: $' + (s.estimated_savings ? s.estimated_savings.toFixed(2) : 0) + '/week'"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- 4. Cost Trend Chart + Time Range Toggle -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Cost Trend</div>
                    <div class="range-toggle">
                        <button class="range-btn" :class="selectedRange === 7 && 'active'" @click="setRange(7)">7d</button>
                        <button class="range-btn" :class="selectedRange === 30 && 'active'" @click="setRange(30)"
                                :disabled="isFree">30d<span class="pro-badge" x-show="isFree">PRO</span></button>
                        <button class="range-btn" :class="selectedRange === 90 && 'active'" @click="setRange(90)"
                                :disabled="isFree">90d<span class="pro-badge" x-show="isFree">PRO</span></button>
                    </div>
                </div>
                <canvas id="costChart" width="400" height="100"></canvas>
            </div>

            <!-- 5. Model & Project Breakdown -->
            <div class="tables-grid">
                <div class="table-container">
                    <div class="table-title">Model Breakdown</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Requests</th>
                                <th>Cost</th>
                                <th>% of Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="model in displayModels" :key="model.model">
                                <tr>
                                    <td class="mono" x-text="model.model"></td>
                                    <td x-text="model.count.toLocaleString()"></td>
                                    <td x-text="'$' + model.cost_usd.toFixed(2)"></td>
                                    <td class="pct-col" x-text="modelPct(model) + '%'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div class="show-more"
                         x-show="stats.models.length > 5"
                         @click="showAllModels = !showAllModels"
                         x-text="showAllModels ? 'Show top 5' : 'Show all ' + stats.models.length + ' models'">
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-title">Project Breakdown</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Cost</th>
                                <th>% of Total</th>
                                <th>Sessions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="project in stats.projects" :key="project.project">
                                <tr>
                                    <td x-text="project.project"></td>
                                    <td x-text="'$' + project.cost_usd.toFixed(2)"></td>
                                    <td class="pct-col" x-text="projectPct(project) + '%'"></td>
                                    <td x-text="project.sessions"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 6. Recent Sessions -->
            <div class="table-container" style="margin-bottom: 1.5rem;">
                <div class="table-title">Recent Sessions</div>
                <table>
                    <thead>
                        <tr>
                            <th>Session ID</th>
                            <th>Project</th>
                            <th>Requests</th>
                            <th>Cost</th>
                            <th>Last Active</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="session in stats.sessions" :key="session.session_id">
                            <tr>
                                <td class="mono" x-text="session.session_id.substring(0, 12)"></td>
                                <td x-text="session.project"></td>
                                <td x-text="session.requests.toLocaleString()"></td>
                                <td x-text="'$' + session.cost_usd.toFixed(2)"></td>
                                <td x-text="formatTime(session.last_active)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- 7. Tool Breakdown (hidden behind toggle) -->
            <div class="table-container" x-show="stats.tools && stats.tools.length > 0" style="margin-bottom: 1.5rem;">
                <div class="collapsible-header" @click="toolsOpen = !toolsOpen">
                    <div class="table-title" style="margin-bottom: 0;">Tool Cost Breakdown</div>
                    <span class="toggle-icon" x-text="toolsOpen ? '&#9660;' : '&#9654;'"></span>
                </div>
                <div x-show="toolsOpen" x-transition style="margin-top: 0.75rem;">
                    <table>
                        <thead>
                            <tr>
                                <th>Tool</th>
                                <th>Calls</th>
                                <th>Cost</th>
                                <th>Avg/Call</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="tool in stats.tools.slice(0, 15)" :key="tool.tool">
                                <tr>
                                    <td class="mono" x-text="tool.tool"></td>
                                    <td x-text="tool.count.toLocaleString()"></td>
                                    <td x-text="'$' + tool.cost_usd.toFixed(2)"></td>
                                    <td x-text="'$' + (tool.cost_usd / tool.count).toFixed(4)"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 8. Pricing Config (collapsed at very bottom) -->
            <div class="table-container" x-data="pricingConfig()" style="margin-bottom: 1rem;">
                <div class="collapsible-header" @click="expanded = !expanded">
                    <div class="table-title" style="margin-bottom: 0;">Pricing Config</div>
                    <span class="toggle-icon" x-text="expanded ? '&#9660;' : '&#9654;'"></span>
                </div>
                <div x-show="expanded" x-transition style="margin-top: 0.75rem;">
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 0.75rem;">
                        <button @click="recalculate()" class="alert-dismiss-all" style="padding: 0.3rem 0.75rem; font-size: 0.8rem;"
                                :disabled="recalculating"
                                x-text="recalculating ? 'Recalculating...' : 'Recalculate All Costs'">
                        </button>
                    </div>
                    <div x-show="recalcResult" style="color: #22c55e; font-size: 0.85rem; margin-bottom: 0.75rem;"
                         x-text="recalcResult"></div>
                    <table>
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th>Provider</th>
                                <th>Events</th>
                                <th>Input $/M</th>
                                <th>Output $/M</th>
                                <th>Cache Read $/M</th>
                                <th>Cache Write $/M</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(m, idx) in pricingModels" :key="m.model + m.provider">
                                <tr>
                                    <td class="mono" style="font-size: 0.75rem;" x-text="m.model"></td>
                                    <td x-text="m.provider || '-'"></td>
                                    <td x-text="m.count"></td>
                                    <td>
                                        <input type="number" step="0.01" min="0"
                                               style="width: 65px; background: #0f172a; border: 1px solid #475569; color: white; padding: 2px 4px; border-radius: 3px; font-size: 0.8rem;"
                                               :value="m.effective_pricing.input"
                                               @change="updatePrice(m, 'input', $event.target.value)">
                                    </td>
                                    <td>
                                        <input type="number" step="0.01" min="0"
                                               style="width: 65px; background: #0f172a; border: 1px solid #475569; color: white; padding: 2px 4px; border-radius: 3px; font-size: 0.8rem;"
                                               :value="m.effective_pricing.output"
                                               @change="updatePrice(m, 'output', $event.target.value)">
                                    </td>
                                    <td>
                                        <input type="number" step="0.01" min="0"
                                               style="width: 65px; background: #0f172a; border: 1px solid #475569; color: white; padding: 2px 4px; border-radius: 3px; font-size: 0.8rem;"
                                               :value="m.effective_pricing.cache_read"
                                               @change="updatePrice(m, 'cache_read', $event.target.value)">
                                    </td>
                                    <td>
                                        <input type="number" step="0.01" min="0"
                                               style="width: 65px; background: #0f172a; border: 1px solid #475569; color: white; padding: 2px 4px; border-radius: 3px; font-size: 0.8rem;"
                                               :value="m.effective_pricing.cache_write"
                                               @change="updatePrice(m, 'cache_write', $event.target.value)">
                                    </td>
                                    <td style="white-space: nowrap;">
                                        <button class="alert-dismiss-all" @click="setFree(m)" title="Set all prices to $0">Free</button>
                                        <button class="alert-dismiss-all" @click="resetDefault(m)" title="Remove override">Reset</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid #334155;">
                        <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 0.5rem;">Provider Wildcard Override</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <input type="text" placeholder="provider (e.g. nvidia)"
                                   x-model="newProvider"
                                   style="width: 120px; background: #0f172a; border: 1px solid #475569; color: white; padding: 4px 8px; border-radius: 3px; font-size: 0.85rem;">
                            <span style="color: #64748b; font-size: 0.85rem;">= all $0</span>
                            <button class="alert-dismiss-all" style="padding: 0.3rem 0.5rem; font-size: 0.8rem;" @click="addProviderWildcard()">Add Free Provider</button>
                        </div>
                        <template x-for="o in overrides.filter(o => o.model === '*')" :key="o.provider">
                            <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem; font-size: 0.8rem;">
                                <span class="mono" x-text="'* / ' + o.provider"></span>
                                <span style="color: #22c55e;">= $0 (all tokens)</span>
                                <button class="alert-dismiss-all" @click="deleteOverride('*', o.provider)">Remove</button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            Powered by ClawTrace
        </footer>
    </div>

    <script>
        // Auth: read device_secret from URL hash, persist in localStorage
        function getDeviceSecret() {
            const hash = window.location.hash.slice(1);
            if (hash && hash.length > 0) {
                localStorage.setItem('clawtrace_secret', hash);
                history.replaceState(null, '', window.location.pathname + window.location.search);
            }
            return localStorage.getItem('clawtrace_secret') || '';
        }

        function authHeaders() {
            const secret = getDeviceSecret();
            const headers = {'Content-Type': 'application/json'};
            if (secret) headers['Authorization'] = 'Bearer ' + secret;
            return headers;
        }

        function authFetch(url, options = {}) {
            const secret = getDeviceSecret();
            if (!options.headers) options.headers = {};
            if (secret) options.headers['Authorization'] = 'Bearer ' + secret;
            return fetch(url, options);
        }

        function pricingConfig() {
            return {
                expanded: false,
                pricingModels: [],
                overrides: [],
                recalculating: false,
                recalcResult: '',
                newProvider: '',

                init() {
                    this.$watch('expanded', (val) => { if (val) this.load(); });
                },

                getDeviceId() {
                    const match = window.location.pathname.match(/\/d\/([^\/]+)/);
                    return match ? match[1] : null;
                },

                async load() {
                    const id = this.getDeviceId();
                    if (!id) return;
                    const [modelsResp, configResp] = await Promise.all([
                        authFetch(`/api/pricing/${id}/models`),
                        authFetch(`/api/pricing/${id}/config`)
                    ]);
                    if (modelsResp.ok) {
                        const data = await modelsResp.json();
                        this.pricingModels = data.models || [];
                    }
                    if (configResp.ok) {
                        const data = await configResp.json();
                        this.overrides = data.overrides || [];
                    }
                },

                async updatePrice(m, field, value) {
                    const id = this.getDeviceId();
                    const price = parseFloat(value);
                    if (isNaN(price) || price < 0) return;
                    const p = {...m.effective_pricing};
                    p[field] = price;
                    await authFetch(`/api/pricing/${id}/config`, {
                        method: 'POST',
                        headers: authHeaders(),
                        body: JSON.stringify({
                            model: m.model,
                            provider: m.provider || '',
                            input_price: p.input,
                            output_price: p.output,
                            cache_read_price: p.cache_read,
                            cache_write_price: p.cache_write,
                        })
                    });
                    await this.load();
                },

                async setFree(m) {
                    const id = this.getDeviceId();
                    await authFetch(`/api/pricing/${id}/config`, {
                        method: 'POST',
                        headers: authHeaders(),
                        body: JSON.stringify({
                            model: m.model, provider: m.provider || '',
                            input_price: 0, output_price: 0,
                            cache_read_price: 0, cache_write_price: 0,
                        })
                    });
                    await this.load();
                },

                async resetDefault(m) {
                    const id = this.getDeviceId();
                    await authFetch(`/api/pricing/${id}/config`, {
                        method: 'DELETE',
                        headers: authHeaders(),
                        body: JSON.stringify({ model: m.model, provider: m.provider || '' })
                    });
                    await this.load();
                },

                async addProviderWildcard() {
                    const id = this.getDeviceId();
                    const prov = this.newProvider.trim();
                    if (!prov) return;
                    await authFetch(`/api/pricing/${id}/config`, {
                        method: 'POST',
                        headers: authHeaders(),
                        body: JSON.stringify({
                            model: '*', provider: prov,
                            input_price: 0, output_price: 0,
                            cache_read_price: 0, cache_write_price: 0,
                        })
                    });
                    this.newProvider = '';
                    await this.load();
                },

                async deleteOverride(model, provider) {
                    const id = this.getDeviceId();
                    await authFetch(`/api/pricing/${id}/config`, {
                        method: 'DELETE',
                        headers: authHeaders(),
                        body: JSON.stringify({ model, provider })
                    });
                    await this.load();
                },

                async recalculate() {
                    const id = this.getDeviceId();
                    this.recalculating = true;
                    this.recalcResult = '';
                    try {
                        const resp = await authFetch(`/api/pricing/${id}/recalculate`, {method: 'POST'});
                        if (resp.ok) {
                            const data = await resp.json();
                            this.recalcResult = `Recalculated ${data.events_updated} events.`;
                        }
                    } catch (e) {
                        this.recalcResult = 'Error recalculating.';
                    }
                    this.recalculating = false;
                }
            }
        }

        function dashboard() {
            return {
                deviceId: null,
                loading: true,
                selectedRange: 7,
                isFree: false,
                stats: {
                    total_requests: 0,
                    total_cost_usd: 0,
                    avg_cost_per_request: 0,
                    total_tokens: 0,
                    top_model: '',
                    days: 7,
                    timeseries: [],
                    models: [],
                    projects: [],
                    sessions: [],
                    tools: []
                },
                suggestions: [],
                alerts: [],
                alertsOpen: false,
                allSuggestionsOpen: false,
                showAllModels: false,
                toolsOpen: false,
                chart: null,

                init() {
                    this.extractDeviceId();
                    this.fetchData();
                    setInterval(() => this.fetchData(), 30000);
                },

                extractDeviceId() {
                    const path = window.location.pathname;
                    const match = path.match(/\/d\/([^\/]+)/);
                    this.deviceId = match ? match[1] : null;
                },

                // --- Computed properties for hero stats ---

                get todayCost() {
                    if (!this.stats.timeseries || this.stats.timeseries.length === 0) return 0;
                    const today = new Date().toISOString().split('T')[0];
                    const todayEntry = this.stats.timeseries.find(d => d.date === today);
                    return todayEntry ? todayEntry.cost_usd : 0;
                },

                get yesterdayCost() {
                    if (!this.stats.timeseries || this.stats.timeseries.length < 2) return 0;
                    const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                    const entry = this.stats.timeseries.find(d => d.date === yesterday);
                    return entry ? entry.cost_usd : 0;
                },

                get todayDelta() {
                    if (this.yesterdayCost === 0) return 0;
                    return ((this.todayCost - this.yesterdayCost) / this.yesterdayCost) * 100;
                },

                get todayDeltaClass() {
                    if (this.yesterdayCost === 0) return 'neutral';
                    return this.todayDelta > 0 ? 'up' : 'down';
                },

                get todayDeltaText() {
                    if (this.yesterdayCost === 0) return 'No data yesterday';
                    const arrow = this.todayDelta > 0 ? '\u2191' : '\u2193';
                    return arrow + Math.abs(this.todayDelta).toFixed(0) + '% vs yesterday';
                },

                get weekCost() {
                    if (!this.stats.timeseries) return 0;
                    const now = new Date();
                    const weekAgo = new Date(now.getTime() - 7 * 86400000).toISOString().split('T')[0];
                    return this.stats.timeseries
                        .filter(d => d.date >= weekAgo)
                        .reduce((sum, d) => sum + d.cost_usd, 0);
                },

                get prevWeekCost() {
                    if (!this.stats.timeseries) return 0;
                    const now = new Date();
                    const weekAgo = new Date(now.getTime() - 7 * 86400000).toISOString().split('T')[0];
                    const twoWeeksAgo = new Date(now.getTime() - 14 * 86400000).toISOString().split('T')[0];
                    return this.stats.timeseries
                        .filter(d => d.date >= twoWeeksAgo && d.date < weekAgo)
                        .reduce((sum, d) => sum + d.cost_usd, 0);
                },

                get weekDelta() {
                    if (this.prevWeekCost === 0) return 0;
                    return ((this.weekCost - this.prevWeekCost) / this.prevWeekCost) * 100;
                },

                get weekDeltaClass() {
                    if (this.prevWeekCost === 0) return 'neutral';
                    return this.weekDelta > 0 ? 'up' : 'down';
                },

                get weekDeltaText() {
                    if (this.prevWeekCost === 0) return this.stats.total_requests.toLocaleString() + ' requests';
                    const arrow = this.weekDelta > 0 ? '\u2191' : '\u2193';
                    return arrow + Math.abs(this.weekDelta).toFixed(0) + '% vs last week';
                },

                get potentialSavings() {
                    return this.suggestions
                        .filter(s => s.severity === 'high' && s.estimated_savings)
                        .reduce((sum, s) => sum + s.estimated_savings, 0);
                },

                get highSuggestionCount() {
                    return this.suggestions.filter(s => s.severity === 'high').length;
                },

                get topCostDriver() {
                    if (!this.stats.models || this.stats.models.length === 0) return 'N/A';
                    const sorted = [...this.stats.models].sort((a, b) => b.cost_usd - a.cost_usd);
                    return sorted[0].model;
                },

                get topCostPct() {
                    if (!this.stats.models || this.stats.models.length === 0) return 0;
                    const sorted = [...this.stats.models].sort((a, b) => b.cost_usd - a.cost_usd);
                    const total = this.stats.total_cost_usd || sorted.reduce((s, m) => s + m.cost_usd, 0);
                    if (total === 0) return 0;
                    return ((sorted[0].cost_usd / total) * 100).toFixed(0);
                },

                get topSuggestions() {
                    return this.suggestions
                        .filter(s => s.severity === 'high')
                        .slice(0, 3);
                },

                get alertSeverityClass() {
                    if (this.alerts.some(a => a.severity === 'critical')) return 'has-crit';
                    if (this.alerts.length > 0) return 'has-warn';
                    return 'has-none';
                },

                get groupedAlerts() {
                    const groups = {};
                    for (const a of this.alerts) {
                        const type = this.alertType(a.message);
                        if (!groups[type]) groups[type] = [];
                        groups[type].push(a);
                    }
                    return groups;
                },

                get displayModels() {
                    if (!this.stats.models) return [];
                    const sorted = [...this.stats.models].sort((a, b) => b.cost_usd - a.cost_usd);
                    return this.showAllModels ? sorted : sorted.slice(0, 5);
                },

                // --- Helper methods ---

                alertType(message) {
                    const m = message.toLowerCase();
                    if (m.includes('session') || m.includes('spike')) return 'session spikes';
                    if (m.includes('budget') || m.includes('daily')) return 'budget warnings';
                    if (m.includes('volume') || m.includes('request') || m.includes('token')) return 'volume alerts';
                    if (m.includes('burn') || m.includes('rate')) return 'burn rate alerts';
                    return 'other alerts';
                },

                modelPct(model) {
                    const total = this.stats.total_cost_usd || this.stats.models.reduce((s, m) => s + m.cost_usd, 0);
                    if (total === 0) return '0';
                    return ((model.cost_usd / total) * 100).toFixed(1);
                },

                projectPct(project) {
                    const total = this.stats.total_cost_usd || this.stats.projects.reduce((s, p) => s + p.cost_usd, 0);
                    if (total === 0) return '0';
                    return ((project.cost_usd / total) * 100).toFixed(1);
                },

                formatTime(timestamp) {
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diff = now - date;
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor(diff / (1000 * 60));
                    if (minutes < 60) return `${minutes}m ago`;
                    if (hours < 24) return `${hours}h ago`;
                    return date.toLocaleDateString();
                },

                async setRange(days) {
                    if (this.isFree && days > 7) return;
                    this.selectedRange = days;
                    await this.fetchData();
                },

                async fetchData() {
                    if (!this.deviceId) {
                        console.error('No device_id found in URL');
                        this.loading = false;
                        return;
                    }

                    try {
                        const [statsResp, optResp, alertsResp] = await Promise.all([
                            authFetch(`/api/stats/${this.deviceId}?days=${this.selectedRange}`),
                            authFetch(`/api/optimize/${this.deviceId}?days=${this.selectedRange}`),
                            authFetch(`/api/alerts/${this.deviceId}?acknowledged=false`)
                        ]);

                        if (statsResp.ok) {
                            this.stats = await statsResp.json();
                            // Detect free tier: if returned days < requested, user is on free
                            if (this.selectedRange > 7 && this.stats.days && this.stats.days <= 7) {
                                this.isFree = true;
                                this.selectedRange = 7;
                            }
                        }
                        if (optResp.ok) {
                            const optData = await optResp.json();
                            this.suggestions = optData.suggestions || [];
                        }
                        if (alertsResp.ok) {
                            const alertData = await alertsResp.json();
                            this.alerts = alertData.alerts || [];
                        }

                        this.loading = false;

                        if (this.stats.total_requests > 0) {
                            this.$nextTick(() => this.renderChart());
                        }
                    } catch (error) {
                        console.error('Error fetching data:', error);
                        this.loading = false;
                    }
                },

                renderChart() {
                    const ctx = document.getElementById('costChart');
                    if (!ctx) return;

                    if (this.chart) this.chart.destroy();

                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: this.stats.timeseries.map(d => d.date),
                            datasets: [{
                                label: 'Daily Cost ($)',
                                data: this.stats.timeseries.map(d => d.cost_usd),
                                borderColor: '#f97316',
                                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: '#94a3b8',
                                        callback: function(value) { return '$' + value.toFixed(2); }
                                    },
                                    grid: { color: '#334155' }
                                },
                                x: {
                                    ticks: { color: '#94a3b8' },
                                    grid: { color: '#334155' }
                                }
                            }
                        }
                    });
                },

                async dismissAlert(alertId) {
                    try {
                        const resp = await authFetch(`/api/alerts/${this.deviceId}/acknowledge/${alertId}`, { method: 'POST' });
                        if (resp.ok) {
                            this.alerts = this.alerts.filter(a => a.id !== alertId);
                        }
                    } catch (error) {
                        console.error('Error dismissing alert:', error);
                    }
                },

                async dismissGroup(items) {
                    for (const alert of items) {
                        await this.dismissAlert(alert.id);
                    }
                }
            }
        }
    </script>
</body>
</html>
